package com.example.market;

import com.example.AbstractCleanDBTest;
import com.example.market.common.data.TimeInterval;
import com.example.market.impl.binance.candlestick.xrp_usdt.model.BinanceXrpUsdtCandlestick;
import com.example.market.impl.binance.candlestick.xrp_usdt.repository.BinanceXrpUsdtCandlestickRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;
import org.springframework.beans.factory.annotation.Autowired;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Stream;

import static com.example.filler.CandlestickFiller.fill;
import static com.example.market.common.data.TimeInterval.*;
import static org.junit.jupiter.api.Assertions.assertEquals;

public class MarketRepositoryTest extends AbstractCleanDBTest {

    @Autowired
    public BinanceXrpUsdtCandlestickRepository repository;

    @Test
    public void saveTest() {
        BinanceXrpUsdtCandlestick candlestick = new BinanceXrpUsdtCandlestick();
        candlestick.fill(1525421460000L, BigDecimal.valueOf(0.50000000), BigDecimal.valueOf(0.50000000),
                BigDecimal.valueOf(0.50000000), BigDecimal.valueOf(0.50000000), BigDecimal.valueOf(109.5100000000),
                1525421519999L, BigDecimal.valueOf(54.7550000000), 1, BigDecimal.valueOf(0.0000000000),
                BigDecimal.valueOf(0.0000000000));

        BinanceXrpUsdtCandlestick savedCandlestick = repository.save(candlestick);

        assertEquals(candlestick, savedCandlestick);
    }

    private static final List<BinanceXrpUsdtCandlestick> candlesticks = fillList();

    @Test
    public void inRangeTest() {
        long openTime = 1525422240000L;
        long closeTime = 1525422299999L;

        repository.saveAll(candlesticks);

        List<BinanceXrpUsdtCandlestick> list = repository.inRange(openTime, closeTime);
        assertEquals(1, list.size());
    }

    private static final Object[] ONE_MINUTE_INTERVAL =
            {ONE_MINUTE, 1525421760000L, 1525422119999L,
                    new long[][]{{1525421760000L, 1525421819999L}, {1525421820000L, 1525421879999L},
                            {1525421880000L, 1525421939999L}, {1525421940000L, 1525421999999L},
                            {1525422000000L, 1525422059999L}, {1525422060000L, 1525422119999L}}};
    private static final Object[] FIVE_MINUTES_INTERVAL_LEFT_PART =
            {FIVE_MINUTES, 1525421820000L, 1525421999999L, new long[][]{{1525421820000L, 1525421999999L}}};
    private static final Object[] FIVE_MINUTES_INTERVAL_FULL_MIDDLE =
            {FIVE_MINUTES, 1525422000000L, 1525422299999L, new long[][]{{1525422000000L, 1525422299999L}}};
    private static final Object[] FIVE_MINUTES_INTERVAL_RIGHT_PART =
            {FIVE_MINUTES, 1525422300000L, 1525422479999L, new long[][]{{1525422300000L, 1525422479999L}}};
    private static final Object[] FIVE_MINUTES_INTERVAL_LEFT_PART_AND_RIGHT_PART =
            {FIVE_MINUTES, 1525421820000L, 1525422239999L, new long[][]
                    {{1525421820000L, 1525421999999L}, {1525422000000L, 1525422239999L}}};
    private static final Object[] FIVE_MINUTES_INTERVAL_LEFT_PART_AND_FULL_MIDDLE_AND_RIGHT_PART =
            {FIVE_MINUTES, 1525421820000L, 1525422479999L, new long[][]
                    {{1525421820000L, 1525421999999L}, {1525422000000L, 1525422299999L}, {1525422300000L, 1525422479999L}}};
    private static final Object[] THIRTY_MINUTES_INTERVAL_LEFT_PART =
            {THIRTY_MINUTES, 1525422120000L, 1525422599999L, new long[][]{{1525422120000L, 1525422599999L}}};
    private static final Object[] THIRTY_MINUTES_INTERVAL_RIGHT_PART =
            {THIRTY_MINUTES, 1525422600000L, 1525424099999L, new long[][]{{1525422600000L, 1525424099999L}}};
    private static final Object[] THIRTY_MINUTES_INTERVAL_LEFT_PART_AND_FULL_MIDDLE_AND_RIGHT_PART =
            {THIRTY_MINUTES, 1525421760000L, 1525425240000L, new long[][]
                    {{1525421760000L, 1525422599999L}, {1525422600000L, 1525424399999L}, {1525424400000L, 1525425299999L}}};

    @ParameterizedTest
    @MethodSource("inRangeWithTimeIntervalTestArguments")
    public void inRangeWithTimeIntervalTest(TimeInterval timeInterval, long start, long end, long[][] openAndCloseTimes) {
        repository.saveAll(candlesticks);

        List<BinanceXrpUsdtCandlestick> candlesticks = repository.inRange(timeInterval, start, end, false);
        assertEquals(openAndCloseTimes.length, candlesticks.size());

        for (int i = 0; i < openAndCloseTimes.length; i++) {
            long[] openAndCloseTime = openAndCloseTimes[i];
            BinanceXrpUsdtCandlestick candlestick = candlesticks.get(i);

            assertEquals(openAndCloseTime[0], candlestick.openTime());
            assertEquals(openAndCloseTime[1], candlestick.closeTime());
        }
    }

    private static Stream<Arguments> inRangeWithTimeIntervalTestArguments() {
        return Stream.of(
                Arguments.of(ONE_MINUTE_INTERVAL),
                Arguments.of(FIVE_MINUTES_INTERVAL_LEFT_PART),
                Arguments.of(FIVE_MINUTES_INTERVAL_FULL_MIDDLE),
                Arguments.of(FIVE_MINUTES_INTERVAL_RIGHT_PART),
                Arguments.of(FIVE_MINUTES_INTERVAL_LEFT_PART_AND_RIGHT_PART),
                Arguments.of(FIVE_MINUTES_INTERVAL_LEFT_PART_AND_FULL_MIDDLE_AND_RIGHT_PART),
                Arguments.of(THIRTY_MINUTES_INTERVAL_LEFT_PART),
                Arguments.of(THIRTY_MINUTES_INTERVAL_RIGHT_PART),
                Arguments.of(THIRTY_MINUTES_INTERVAL_LEFT_PART_AND_FULL_MIDDLE_AND_RIGHT_PART)
//                                Arguments.of(FIVE_MINUTES_INTERVAL_LEFT_PART)

        );
    }

    private static List<BinanceXrpUsdtCandlestick> fillList() {
        return List.of(
                fill(1525421700000L, 0.92999000, 0.95001000, 0.91020000, 0.91020000, 171304.5600000000, 1525421759999L, 157893.8514214000, 535, 28832.4000000000, 26792.2072038000),
                fill(1525421760000L, 0.91020000, 0.92981000, 0.91020000, 0.92977000, 62126.1600000000, 1525421819999L, 57208.8847960000, 139, 39303.3500000000, 36393.6817856000),
                fill(1525421820000L, 0.92976000, 0.92977000, 0.91400000, 0.91500000, 162886.5000000000, 1525421879999L, 149223.8808422000, 352, 29658.9200000000, 27210.1669172000),
                fill(1525421880000L, 0.91500000, 0.92498000, 0.91400000, 0.92491000, 80941.8400000000, 1525421939999L, 74567.6998656000, 169, 38143.1400000000, 35133.7684157000),
                fill(1525421940000L, 0.92480000, 0.93000000, 0.92310000, 0.92800000, 92286.9600000000, 1525421999999L, 85492.7311694000, 178, 48690.6100000000, 45129.2097570000),
                fill(1525422000000L, 0.92800000, 0.93900000, 0.92730000, 0.93402000, 235394.5600000000, 1525422059999L, 220042.5522228000, 364, 32927.7500000000, 30750.5876163000),
                fill(1525422060000L, 0.93402000, 0.93822000, 0.92012000, 0.93100000, 294366.2500000000, 1525422119999L, 274501.9282956000, 526, 34136.4100000000, 31861.3116887000),
                fill(1525422120000L, 0.92495000, 0.93096000, 0.92155000, 0.92389000, 88288.6500000000, 1525422179999L, 81518.4060488000, 162, 30917.7300000000, 28545.3654868000),
                fill(1525422180000L, 0.92165000, 0.92378000, 0.91000000, 0.91120000, 227162.6200000000, 1525422239999L, 208351.8570618000, 387, 68189.4700000000, 62544.1810955000),
                fill(1525422240000L, 0.91120000, 0.91506000, 0.91120000, 0.91505000, 31583.6100000000, 1525422299999L, 28879.8184244000, 76, 17145.9700000000, 15682.2940197000),
                fill(1525422300000L, 0.91505000, 0.91897000, 0.91120000, 0.91229000, 80816.2100000000, 1525422359999L, 73908.2231970000, 203, 28555.7300000000, 26123.8985378000),
                fill(1525422360000L, 0.91229000, 0.91501000, 0.90800000, 0.91218000, 109243.5600000000, 1525422419999L, 99571.7964920000, 196, 46825.3100000000, 42705.1843110000),
                fill(1525422420000L, 0.91217000, 0.91504000, 0.91196000, 0.91500000, 48884.1700000000, 1525422479999L, 44676.6441300000, 78, 38307.0700000000, 35017.4856465000),
                fill(1525422480000L, 0.91500000, 0.91896000, 0.91450000, 0.91891000, 47198.4100000000, 1525422539999L, 43345.9065565000, 89, 23088.3700000000, 21204.9377017000),
                fill(1525422540000L, 0.91888000, 0.91896000, 0.91800000, 0.91809000, 108313.3000000000, 1525422599999L, 99483.0108605000, 211, 20491.9500000000, 18827.6327233000),
                fill(1525422600000L, 0.91809000, 0.91896000, 0.91600000, 0.91600000, 121882.1700000000, 1525422659999L, 111903.8658832000, 244, 18388.4500000000, 16893.2043344000),
                fill(1525422660000L, 0.91600000, 0.91600000, 0.90190000, 0.90209000, 109930.6800000000, 1525422719999L, 99743.9585563000, 219, 33869.3000000000, 30685.3985397000),
                fill(1525422720000L, 0.90208000, 0.90799000, 0.90208000, 0.90514000, 32462.4900000000, 1525422779999L, 29339.6607798000, 88, 22981.6300000000, 20769.6533903000),
                fill(1525422780000L, 0.90518000, 0.91249000, 0.90518000, 0.91249000, 57710.6500000000, 1525422839999L, 52441.0293936000, 94, 32949.6600000000, 29956.7387156000),
                fill(1525422840000L, 0.91005000, 0.91250000, 0.91000000, 0.91001000, 51187.9400000000, 1525422899999L, 46657.8968226000, 116, 18689.2300000000, 17043.1137037000),
                fill(1525422900000L, 0.91111000, 0.91329000, 0.91002000, 0.91249000, 139489.1500000000, 1525422959999L, 127254.8023299000, 217, 33766.2000000000, 30795.0188425000),
                fill(1525422960000L, 0.91249000, 0.91249000, 0.91109000, 0.91200000, 27839.4100000000, 1525423019999L, 25391.2732863000, 67, 16749.0100000000, 15282.4906094000),
                fill(1525423020000L, 0.91200000, 0.91200000, 0.91114000, 0.91197000, 58271.5300000000, 1525423079999L, 53133.2251068000, 130, 22075.3400000000, 20130.3976502000),
                fill(1525423080000L, 0.91197000, 0.91320000, 0.91197000, 0.91320000, 37728.1300000000, 1525423139999L, 34411.6547448000, 114, 24796.4300000000, 22617.6015898000),
                fill(1525423140000L, 0.91320000, 0.91900000, 0.91302000, 0.91900000, 79954.8100000000, 1525423199999L, 73249.9390272000, 89, 63333.7000000000, 58006.7426712000),
                fill(1525423200000L, 0.91900000, 0.92500000, 0.91900000, 0.92500000, 108348.2500000000, 1525423259999L, 99873.8988271000, 232, 51264.1800000000, 47275.5319853000),
                fill(1525423260000L, 0.92225000, 0.93260000, 0.92224000, 0.92893000, 200559.2100000000, 1525423319999L, 186190.7574057000, 350, 72871.6200000000, 67719.6104874000),
                fill(1525423320000L, 0.93000000, 0.93505000, 0.92898000, 0.93250000, 115198.1300000000, 1525423379999L, 107454.3893210000, 206, 30663.5800000000, 28620.0396781000),
                fill(1525423380000L, 0.93250000, 0.93260000, 0.92101000, 0.92495000, 138897.7300000000, 1525423439999L, 128832.6877720000, 263, 33990.9800000000, 31540.5819922000),
                fill(1525423440000L, 0.92497000, 0.93500000, 0.92497000, 0.93500000, 132694.2600000000, 1525423499999L, 123302.3791344000, 246, 79239.5900000000, 73590.4422928000),
                fill(1525423500000L, 0.93180000, 0.93450000, 0.92684000, 0.92750000, 232753.8300000000, 1525423559999L, 216568.2161562000, 311, 30831.9300000000, 28696.5340521000),
                fill(1525423560000L, 0.92998000, 0.92999000, 0.92751000, 0.92790000, 30342.6000000000, 1525423619999L, 28195.5483421000, 58, 20168.2400000000, 18752.3362057000),
                fill(1525423620000L, 0.92973000, 0.92997000, 0.92794000, 0.92997000, 40996.1000000000, 1525423679999L, 38088.0576941000, 80, 30837.8000000000, 28651.8061614000),
                fill(1525423680000L, 0.92903000, 0.93600000, 0.92899000, 0.93445000, 114537.5400000000, 1525423739999L, 106811.4168807000, 256, 78746.2700000000, 73466.9407911000),
                fill(1525423740000L, 0.93445000, 0.93600000, 0.93256000, 0.93594000, 61810.5200000000, 1525423799999L, 57781.6723822000, 108, 33332.1700000000, 31164.7966689000),
                fill(1525423800000L, 0.93594000, 0.93600000, 0.92900000, 0.93000000, 126412.3000000000, 1525423859999L, 118209.8447114000, 201, 53179.6500000000, 49757.9925517000),
                fill(1525423860000L, 0.92900000, 0.93447000, 0.92801000, 0.92900000, 40173.3900000000, 1525423919999L, 37349.0198272000, 141, 12965.4600000000, 12067.1545239000),
                fill(1525423920000L, 0.92899000, 0.92998000, 0.92804000, 0.92843000, 63438.9300000000, 1525423979999L, 58932.3086240000, 173, 20916.0700000000, 19432.3204395000),
                fill(1525423980000L, 0.92850000, 0.92850000, 0.92250000, 0.92298000, 139700.6600000000, 1525424039999L, 129515.8048157000, 340, 8166.1700000000, 7570.4706967000),
                fill(1525424040000L, 0.92296000, 0.92400000, 0.92293000, 0.92296000, 46723.1300000000, 1525424099999L, 43156.9788952000, 61, 29455.2200000000, 27212.0817118000),
                fill(1525424100000L, 0.92296000, 0.92300000, 0.91600000, 0.91601000, 141636.5500000000, 1525424159999L, 130541.8055227000, 329, 33423.6500000000, 30823.8613076000),
                fill(1525424160000L, 0.91884000, 0.92140000, 0.91600000, 0.92140000, 43485.2700000000, 1525424219999L, 39945.4904808000, 124, 17261.1500000000, 15862.3971796000),
                fill(1525424220000L, 0.92100000, 0.92189000, 0.91730000, 0.92001000, 188876.0200000000, 1525424279999L, 173803.2667055000, 438, 37431.9500000000, 34454.1492166000),
                fill(1525424280000L, 0.92000000, 0.92292000, 0.92000000, 0.92108000, 62523.6400000000, 1525424339999L, 57559.6499572000, 147, 31501.6200000000, 29012.9407128000),
                fill(1525424340000L, 0.92108000, 0.92680000, 0.92108000, 0.92300000, 49868.9000000000, 1525424399999L, 46035.2849081000, 144, 18868.6500000000, 17421.4705176000),
                fill(1525424400000L, 0.92300000, 0.92498000, 0.92211000, 0.92300000, 80578.9500000000, 1525424459999L, 74385.7769833000, 253, 10730.9000000000, 9912.2428888000),
                fill(1525424460000L, 0.92300000, 0.92300000, 0.92210000, 0.92210000, 83601.7500000000, 1525424519999L, 77154.5009048000, 152, 8541.3300000000, 7883.6275137000),
                fill(1525424520000L, 0.92230000, 0.92300000, 0.92108000, 0.92287000, 39894.1400000000, 1525424579999L, 36792.6704147000, 54, 23921.1800000000, 22066.1395317000),
                fill(1525424580000L, 0.92201000, 0.92287000, 0.92201000, 0.92209000, 35141.9900000000, 1525424639999L, 32406.7907422000, 85, 1822.6000000000, 1682.0174963000),
                fill(1525424640000L, 0.92209000, 0.92209000, 0.91612000, 0.91612000, 133663.7600000000, 1525424699999L, 122993.8545208000, 212, 30526.8700000000, 28081.6730147000),
                fill(1525424700000L, 0.91614000, 0.91615000, 0.91111000, 0.91135000, 58347.2600000000, 1525424759999L, 53242.8629881000, 86, 7653.3300000000, 6985.8422730000),
                fill(1525424760000L, 0.91297000, 0.91315000, 0.91133000, 0.91300000, 35812.6200000000, 1525424819999L, 32672.0879632000, 88, 21941.4200000000, 20028.6140837000),
                fill(1525424820000L, 0.91446000, 0.91600000, 0.91300000, 0.91300000, 42320.4600000000, 1525424879999L, 38693.8131074000, 117, 8778.2800000000, 8028.5942409000),
                fill(1525424880000L, 0.91300000, 0.91413000, 0.91140000, 0.91146000, 67167.3200000000, 1525424939999L, 61312.4477144000, 231, 941.8800000000, 859.7406631000),
                fill(1525424940000L, 0.91140000, 0.91212000, 0.91140000, 0.91212000, 27455.6000000000, 1525424999999L, 25027.4966846000, 79, 10176.0300000000, 9277.3961685000),
                fill(1525425000000L, 0.91212000, 0.91400000, 0.91160000, 0.91216000, 81024.8200000000, 1525425059999L, 74014.9347565000, 136, 23421.9500000000, 21378.6854264000),
                fill(1525425060000L, 0.91217000, 0.91655000, 0.91216000, 0.91655000, 108994.5300000000, 1525425119999L, 99440.4060880000, 103, 71076.3900000000, 64849.3775740000),
                fill(1525425120000L, 0.91655000, 0.91985000, 0.91655000, 0.91985000, 20705.6400000000, 1525425179999L, 18991.3437421000, 55, 14484.6000000000, 13285.4876594000),
                fill(1525425180000L, 0.91900000, 0.92100000, 0.91900000, 0.92100000, 33580.5700000000, 1525425239999L, 30901.2411002000, 128, 11467.3800000000, 10549.7017306000),
                fill(1525425240000L, 0.92115000, 0.92850000, 0.92000000, 0.92300000, 126332.7500000000, 1525425299999L, 116625.8046128000, 140, 63832.0800000000, 59015.4569632000),
                fill(1525425300000L, 0.92300000, 0.92810000, 0.92121000, 0.92122000, 149929.6600000000, 1525425359999L, 138379.6925536000, 197, 10727.2600000000, 9911.6000733000)
        );
    }
}
